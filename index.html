<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Whistle Studio</title>
  </head>
  <body>
    <div id="app">
      <header class="topbar">
        <h1>Whistle Studio</h1>
        <div class="topbar-actions">
          <button id="theme-toggle-btn" class="icon-btn" aria-label="Toggle theme" title="Toggle theme"></button>
          <button id="unlock-audio-btn">Unlock Audio</button>
          <button id="save-btn">Save Project</button>
          <button id="export-wav-btn">Export WAV</button>
          <button id="export-all-btn">Export All</button>
          <span id="status-text" class="status">Ready</span>
        </div>
      </header>

      <main class="layout">
        <aside class="panel left-panel">
          <div class="panel-header">
            <h2>Library</h2>
            <button id="toggle-trash-btn">Trash</button>
          </div>
          <div class="toolbar-row">
            <button id="new-folder-btn">New Folder</button>
            <button id="rename-folder-btn">Rename</button>
            <button id="delete-folder-btn">Delete</button>
          </div>
          <ul id="folder-tree" class="list"></ul>
          <div class="panel-subheader">
            <h3>Projects</h3>
          </div>
          <div class="toolbar-row">
            <button id="new-project-btn">New</button>
            <button id="rename-project-btn">Rename</button>
            <button id="move-project-btn">Move</button>
            <button id="delete-project-btn">Delete</button>
          </div>
          <ul id="project-list" class="list"></ul>
          <div class="panel-subheader">
            <h3>Files</h3>
          </div>
          <div class="toolbar-row">
            <button id="new-file-btn">New File</button>
            <button id="rename-file-btn">Rename</button>
            <button id="delete-file-btn">Delete</button>
          </div>
          <ul id="file-list" class="list"></ul>
          <details class="help-panel" open>
            <summary><span class="help-arrow"></span> Help</summary>
            <div class="help-content">
              <p><strong>Record / Pause / Resume / Stop</strong>: capture a new microphone take.</p>
              <p><strong>Discard Take</strong>: remove current source audio from this project.</p>
              <p><strong>Analyze</strong>: regenerate Segments and Melody JSON from current audio.</p>
              <p><strong>Reset</strong>: clears generated segments and melody output.</p>
              <p><strong>Auto Settings</strong>: estimates RMS, clarity, pitch range, and min note length.</p>
              <p><strong>Analysis Mode</strong>: Monophonic for whistle/single voice, Full Mix Assist for dense songs.</p>
              <p><strong>Output</strong>: Lead only exports single melody, Auto Arrange builds SNES-lite backing tracks.</p>
              <p><strong>Style</strong>: SNES-lite is richer by default, NES is simpler and more chiptune-limited.</p>
              <p><strong>RMS threshold</strong>: loudness cutoff for note vs rest detection.</p>
              <p><strong>Clarity threshold</strong>: pitch confidence cutoff for valid note frames.</p>
              <p><strong>Triplets</strong>: quantizes timing to three evenly spaced notes per beat, useful for shuffle or swing-like rhythm feel.</p>
              <p><strong>Snap to key</strong>: pulls notes to the selected key within tolerance cents.</p>
              <p><strong>Export file name</strong>: base name used for JSON, JS, and MIDI exports.</p>
              <p><strong>Synth Tone</strong>: playback style, it does not change exported notes.</p>
              <div class="help-debug-row">
                <button id="copy-debug-btn">Debug Copy</button>
              </div>
            </div>
          </details>
          <div id="trash-actions" class="toolbar-row hidden">
            <button id="restore-btn">Restore</button>
            <button id="empty-trash-btn" class="danger">Empty Trash</button>
          </div>
        </aside>

        <section class="panel center-panel">
          <h2>Capture and Analyze</h2>
          <div id="recording-indicator" class="recording-indicator hidden" aria-live="polite">
            <span id="recording-dot" class="record-dot"></span>
            <strong id="recording-state">REC</strong>
            <span id="recording-timer">00:00</span>
          </div>
          <div class="capture-controls">
            <button id="record-btn">Record</button>
            <button id="pause-btn" disabled>Pause</button>
            <button id="resume-btn" disabled>Resume</button>
            <button id="stop-btn" disabled>Stop</button>
            <button id="discard-take-btn">Discard Take</button>
            <input id="upload-input" type="file" accept="audio/*" />
          </div>
          <div class="capture-controls">
            <button id="analyze-btn">Analyze</button>
            <button id="reset-analysis-btn">Reset</button>
          </div>
          <section class="playback-block">
            <h3>Source Audio</h3>
            <audio id="audio-preview" controls></audio>
          </section>
          <section class="playback-block">
            <div class="playback-title-row">
              <h3>Synth Playback</h3>
              <label class="tone-header">Tone
                <select id="synth-tone-select">
                  <option value="whistle">Whistle</option>
                  <option value="nes" selected>NES Lead</option>
                  <option value="gba">GBA Pulse</option>
                  <option value="organ">Organ Soft</option>
                  <option value="piano">Piano Pluck</option>
                  <option value="guitar">Guitar Pluck</option>
                </select>
              </label>
            </div>
            <audio id="synth-audio-preview" controls></audio>
            <div class="synth-pill hidden" aria-hidden="true">
              <button id="synth-play-btn" class="pill-btn" aria-label="Play synth">Play</button>
              <input id="synth-seek-input" class="synth-seek" type="range" min="0" max="1000" value="0" />
              <span id="synth-time-label" class="status">0:00 / 0:00</span>
              <button id="synth-mute-btn" class="pill-btn" aria-label="Mute synth">Vol</button>
              <details class="synth-menu">
                <summary class="pill-btn" aria-label="Playback options">...</summary>
                <div class="synth-menu-panel">
                  <label>Speed
                    <select id="synth-speed-select">
                      <option value="0.75">0.75x</option>
                      <option value="1" selected>1x</option>
                      <option value="1.25">1.25x</option>
                      <option value="1.5">1.5x</option>
                    </select>
                  </label>
                  <label>Volume
                    <input id="synth-volume-input" type="range" min="0" max="1" step="0.01" value="1" />
                  </label>
                  <button id="synth-stop-btn" class="pill-btn">Stop</button>
                </div>
              </details>
            </div>
          </section>
          <div id="analysis-warning" class="warning"></div>
          <div class="segments-wrap">
            <div class="panel-header">
              <h3>Segments</h3>
              <button id="copy-segments-btn">Copy</button>
            </div>
            <textarea id="segments-view" class="segments-view" readonly></textarea>
          </div>
          <div class="segments-wrap">
            <h3>File Editor</h3>
            <textarea id="file-editor" class="file-editor" placeholder="Create a file to store notes, lyric cues, or annotations."></textarea>
          </div>
        </section>

        <aside class="panel right-panel">
          <div class="panel-header">
            <h2>Settings</h2>
            <div class="toolbar-row">
              <button id="auto-settings-btn">Auto Detect Settings</button>
              <button id="reset-settings-btn">Reset Defaults</button>
            </div>
          </div>
          <p class="help-text">Unlock Audio enables browser playback after user interaction.</p>
          <label>BPM <input id="bpm-input" type="number" min="30" max="240" value="120" /></label>
          <label>Grid
            <select id="grid-select">
              <option value="quarter">Quarter</option>
              <option value="eighth" selected>Eighth</option>
              <option value="sixteenth">Sixteenth</option>
            </select>
          </label>
          <label>Analysis mode
            <select id="analysis-mode-select">
              <option value="monophonic" selected>Monophonic</option>
              <option value="full_mix">Full Mix Assist</option>
            </select>
          </label>
          <label>Output
            <select id="output-style-select">
              <option value="auto_arrange" selected>Auto Arrange</option>
              <option value="lead_only">Lead only</option>
            </select>
          </label>
          <label>Style
            <select id="retro-style-select">
              <option value="snes_lite" selected>SNES-lite</option>
              <option value="nes">NES</option>
            </select>
          </label>
          <label><input id="triplet-toggle" type="checkbox" /> Triplets</label>
          <label>RMS threshold <span id="rms-value" class="status"></span><input id="rms-input" type="range" min="0.001" max="0.1" step="0.001" value="0.02" /></label>
          <p class="help-text">Lower catches quiet notes, higher marks quiet audio as REST.</p>
          <label>Clarity threshold <span id="clarity-value" class="status"></span><input id="clarity-input" type="range" min="0.1" max="0.99" step="0.01" value="0.75" /></label>
          <p class="help-text">Higher requires more confident pitch tracking, lower accepts noisier pitch.</p>
          <label>Min note ms <input id="min-note-ms-input" type="number" min="20" max="500" value="80" /></label>
          <label>Pitch range Hz
            <div class="inline-pair">
              <input id="min-hz-input" type="number" min="50" max="1200" value="200" />
              <input id="max-hz-input" type="number" min="500" max="5000" value="2500" />
            </div>
          </label>
          <label>Key mode
            <select id="key-mode-select">
              <option value="auto" selected>Auto</option>
              <option value="manual">Manual</option>
            </select>
          </label>
          <label>Key <select id="key-select"></select></label>
          <label>Scale
            <select id="scale-select">
              <option value="major">Major</option>
              <option value="minor">Minor</option>
            </select>
          </label>
          <label><input id="snap-toggle" type="checkbox" checked /> Snap to key</label>
          <label>Snap tolerance cents <input id="snap-cents-input" type="number" min="5" max="100" value="50" /></label>
          <label>Export file name <input id="export-name-input" type="text" placeholder="My Melody" /></label>
          <p class="help-text">Used as the base for JSON, JS, and MIDI exports.</p>
          <p id="suggested-key-text" class="status"></p>
          <div class="toolbar-row">
            <button id="copy-settings-btn">Copy Settings</button>
          </div>
        </aside>
      </main>

      <section class="panel bottom-panel">
        <div class="panel-header">
          <h2>Melody JSON Preview</h2>
          <button id="copy-json-btn">Copy</button>
        </div>
        <pre id="json-preview"></pre>
      </section>
    </div>
    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
