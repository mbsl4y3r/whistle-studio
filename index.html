<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="/alligator.png?v=2" />
    <title>Whistle Studio</title>
  </head>
  <body>
    <div id="app">
      <header class="topbar">
        <h1>Whistle Studio</h1>
        <div class="topbar-actions">
          <span id="status-text" class="status">Ready</span>
          <button id="theme-toggle-btn" class="icon-btn" aria-label="Toggle theme" title="Toggle theme"></button>
        </div>
      </header>

      <main class="layout">
        <aside class="panel left-panel">
          <div class="panel-header">
            <h2>AI Music</h2>
          </div>
          <label>Prompt
            <textarea id="ai-prompt-input" class="ai-prompt" placeholder="Example: 30 second SNES-style adventure loop, bright melody, steady drums."></textarea>
          </label>
          <label>Style hint
            <select id="ai-style-select">
              <option value="snes_lite" selected>SNES-lite</option>
              <option value="nes">NES</option>
              <option value="chiptune">Chiptune</option>
            </select>
          </label>
          <label>Duration (seconds)
            <input id="ai-duration-input" type="number" min="5" max="120" value="30" />
          </label>
          <div class="toolbar-row">
            <button id="ai-generate-btn">Generate 30s Clip</button>
          </div>
          <p class="help-text">
            Requires a local backend endpoint at <code>/api/generate-music</code>. If unavailable, upload audio manually.
          </p>

          <section class="legacy-library hidden" aria-hidden="true">
            <button id="toggle-trash-btn">Trash</button>
            <div class="toolbar-row">
              <button id="new-folder-btn">New Folder</button>
              <button id="rename-folder-btn">Rename</button>
              <button id="delete-folder-btn">Delete</button>
            </div>
            <ul id="folder-tree" class="list"></ul>
            <div class="panel-subheader">
              <h3>Projects</h3>
            </div>
            <div class="toolbar-row">
              <button id="new-project-btn">New</button>
              <button id="rename-project-btn">Rename</button>
              <button id="move-project-btn">Move</button>
              <button id="delete-project-btn">Delete</button>
            </div>
            <ul id="project-list" class="list"></ul>
            <div class="panel-subheader">
              <h3>Files</h3>
            </div>
            <div class="toolbar-row">
              <button id="new-file-btn">New File</button>
              <button id="rename-file-btn">Rename</button>
              <button id="delete-file-btn">Delete</button>
            </div>
            <ul id="file-list" class="list"></ul>
            <div id="trash-actions" class="toolbar-row hidden">
              <button id="restore-btn">Restore</button>
              <button id="empty-trash-btn" class="danger">Empty Trash</button>
            </div>
          </section>

          <div class="panel-subheader">
            <h3>Help</h3>
          </div>
          <details class="help-panel" open>
            <summary><span class="help-arrow"></span> Help</summary>
            <div class="help-content">
              <p><strong>Record / Pause / Resume / Stop</strong>: capture a new microphone take.</p>
              <p><strong>Discard Take</strong>: remove current source audio from this project.</p>
              <p><strong>Analyze</strong>: regenerate segments and melody from current audio.</p>
              <p><strong>Reset</strong>: clears generated segments and melody output.</p>
              <p><strong>Output</strong>: Auto Arrange builds a full retro arrangement, Lead only keeps the melody line.</p>
              <p><strong>Style</strong>: SNES-lite is richer and default, NES is simpler and more classic 8-bit.</p>
              <p><strong>Continuity</strong>: Seamless removes awkward pauses, Natural keeps original rests.</p>
              <p><strong>Auto Detect Settings</strong>: picks settings for you and is recommended for most songs.</p>
              <p><strong>Override BPM and Key</strong>: lets you manually change just BPM and key in Basic settings.</p>
              <p><strong>Advanced</strong>: technical controls for detailed tuning, collapsed by default.</p>
              <p><strong>Override Auto Settings</strong>: enables manual tuning of technical fields.</p>
              <p><strong>Rhythm grid</strong>: note timing resolution used during quantization.</p>
              <p><strong>Allow triplets</strong>: allows 3-notes-per-beat timing.</p>
              <p><strong>Silence sensitivity</strong>: higher values mark more quiet audio as rests.</p>
              <p><strong>Pitch confidence</strong>: higher values require cleaner pitch tracking.</p>
              <p><strong>Minimum note length</strong>: merges tiny fragments into nearby notes/rests.</p>
              <p><strong>Pitch range</strong>: limits detected notes to a frequency band.</p>
              <p><strong>Force notes into key</strong>: nudges notes toward key tones.</p>
              <p><strong>Snap tolerance</strong>: maximum cents offset allowed for snapping.</p>
              <p><strong>Export file name</strong>: base name used for JSON, JS, and MIDI exports.</p>
              <div class="help-debug-row">
                <button id="copy-debug-btn">Debug Copy</button>
              </div>
            </div>
          </details>
        </aside>

        <section class="panel center-panel">
          <h2>Capture and Analyze</h2>
          <div id="recording-indicator" class="recording-indicator hidden" aria-live="polite">
            <span id="recording-dot" class="record-dot"></span>
            <strong id="recording-state">REC</strong>
            <span id="recording-timer">00:00</span>
          </div>
          <div class="capture-controls">
            <button id="record-btn">Record</button>
            <button id="pause-btn" disabled>Pause</button>
            <button id="resume-btn" disabled>Resume</button>
            <button id="stop-btn" disabled>Stop</button>
            <button id="discard-take-btn">Discard Take</button>
            <input id="upload-input" type="file" accept="audio/*" />
          </div>
          <div class="capture-controls">
            <button id="analyze-btn">Analyze</button>
            <button id="reset-analysis-btn">Reset</button>
          </div>
          <section class="playback-block">
            <h3>Source Audio</h3>
            <audio id="audio-preview" controls></audio>
          </section>
          <section class="playback-block">
            <div class="playback-title-row">
              <h3>Synth Playback</h3>
            </div>
            <audio id="synth-audio-preview" controls></audio>
            <div class="synth-pill hidden" aria-hidden="true">
              <button id="synth-play-btn" class="pill-btn" aria-label="Play synth">Play</button>
              <input id="synth-seek-input" class="synth-seek" type="range" min="0" max="1000" value="0" />
              <span id="synth-time-label" class="status">0:00 / 0:00</span>
              <button id="synth-mute-btn" class="pill-btn" aria-label="Mute synth">Vol</button>
              <details class="synth-menu">
                <summary class="pill-btn" aria-label="Playback options">...</summary>
                <div class="synth-menu-panel">
                  <label>Speed
                    <select id="synth-speed-select">
                      <option value="0.75">0.75x</option>
                      <option value="1" selected>1x</option>
                      <option value="1.25">1.25x</option>
                      <option value="1.5">1.5x</option>
                    </select>
                  </label>
                  <label>Volume
                    <input id="synth-volume-input" type="range" min="0" max="1" step="0.01" value="1" />
                  </label>
                  <button id="synth-stop-btn" class="pill-btn">Stop</button>
                </div>
              </details>
            </div>
          </section>
          <div id="analysis-warning" class="warning"></div>
          <div class="segments-wrap">
            <div class="panel-header">
              <h3>Segments</h3>
              <button id="copy-segments-btn">Copy</button>
            </div>
            <textarea id="segments-view" class="segments-view" readonly></textarea>
          </div>
          <div class="segments-wrap">
            <h3>File Editor</h3>
            <textarea id="file-editor" class="file-editor" placeholder="Create a file to store notes, lyric cues, or annotations."></textarea>
          </div>
        </section>

        <aside class="panel right-panel">
          <div class="panel-header">
            <h2>Settings</h2>
            <div class="toolbar-row">
              <button id="auto-settings-btn">Auto Detect Settings</button>
              <button id="reset-settings-btn">Reset Defaults</button>
            </div>
          </div>
          <section class="basic-settings">
            <label>Output
              <select id="output-style-select">
                <option value="auto_arrange" selected>Auto Arrange</option>
                <option value="lead_only">Lead only</option>
              </select>
            </label>
            <label>Style
              <select id="retro-style-select">
                <option value="snes_lite" selected>SNES-lite</option>
                <option value="nes">NES</option>
              </select>
            </label>
            <label>Continuity
              <select id="continuity-mode-select">
                <option value="seamless" selected>Seamless</option>
                <option value="natural">Natural</option>
              </select>
            </label>
            <label id="continuity-intensity-wrap">Seamless intensity <span id="continuity-intensity-value" class="status"></span><input id="continuity-intensity-input" type="range" min="0" max="100" step="1" value="60" /></label>
            <p id="auto-summary-text" class="status">Auto detected: waiting for analysis</p>
            <label><input id="override-bpm-key-toggle" type="checkbox" /> Override BPM and Key</label>
            <div id="bpm-key-readonly-row" class="inline-pair">
              <label>BPM <input id="bpm-readonly-input" type="text" readonly /></label>
              <label>Key <input id="key-readonly-input" type="text" readonly /></label>
            </div>
            <div id="bpm-key-edit-row" class="inline-pair hidden">
              <label>BPM <input id="bpm-input" type="number" min="30" max="240" value="120" /></label>
              <label>Key <select id="key-select"></select></label>
            </div>
            <label>Export file name <input id="export-name-input" type="text" placeholder="My Melody" /></label>
            <div class="toolbar-row transport-row">
              <button id="transport-play-btn">Play</button>
              <button id="transport-stop-btn">Stop</button>
              <button id="unlock-audio-btn">Unlock Audio</button>
            </div>
            <div class="toolbar-row transport-row">
              <button id="export-all-btn">Export All</button>
              <button id="export-wav-btn">Export WAV</button>
              <button id="save-btn">Save Project</button>
            </div>
            <p id="suggested-key-text" class="status"></p>
          </section>

          <details id="advancedSettings" class="advanced-panel">
            <summary><span class="help-arrow"></span>Advanced</summary>
            <div class="advanced-body">
              <label><input id="override-auto-toggle" type="checkbox" /> Override Auto Settings</label>
              <p id="auto-settings-note" class="help-text">Auto settings active</p>
              <label>Analysis mode
                <select id="analysis-mode-select">
                  <option value="monophonic" selected>Monophonic</option>
                  <option value="full_mix">Full Mix Assist</option>
                </select>
              </label>
              <label>Rhythm grid
                <select id="grid-select">
                  <option value="quarter">Quarter</option>
                  <option value="eighth" selected>Eighth</option>
                  <option value="sixteenth">Sixteenth</option>
                </select>
              </label>
              <label><input id="triplet-toggle" type="checkbox" /> Allow triplets</label>
              <label>Silence sensitivity <span id="rms-value" class="status"></span><input id="rms-input" type="range" min="0.001" max="0.1" step="0.001" value="0.02" /></label>
              <label>Pitch confidence <span id="clarity-value" class="status"></span><input id="clarity-input" type="range" min="0.1" max="0.99" step="0.01" value="0.75" /></label>
              <label>Minimum note length <input id="min-note-ms-input" type="number" min="20" max="500" value="80" /></label>
              <label>Pitch range
                <div class="inline-pair">
                  <input id="min-hz-input" type="number" min="50" max="1200" value="200" />
                  <input id="max-hz-input" type="number" min="500" max="5000" value="2500" />
                </div>
              </label>
              <label>Key mode
                <select id="key-mode-select">
                  <option value="auto" selected>Auto</option>
                  <option value="manual">Manual</option>
                </select>
              </label>
              <label>Scale
                <select id="scale-select">
                  <option value="major">Major</option>
                  <option value="minor">Minor</option>
                </select>
              </label>
              <label><input id="snap-toggle" type="checkbox" checked /> Force notes into key</label>
              <label>Snap tolerance <input id="snap-cents-input" type="number" min="5" max="100" value="50" /></label>
              <div class="toolbar-row">
                <button id="reset-advanced-btn">Reset Advanced to Auto Defaults</button>
              </div>
              <div class="toolbar-row">
                <button id="copy-settings-btn">Copy Settings</button>
              </div>
            </div>
          </details>
        </aside>
      </main>

      <section class="panel bottom-panel">
        <div class="panel-header">
          <h2>Melody JSON Preview</h2>
          <button id="copy-json-btn">Copy</button>
        </div>
        <pre id="json-preview"></pre>
      </section>
    </div>
    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
